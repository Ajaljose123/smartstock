<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SmartStock Supermarket Bill</title>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
body { font-family: 'Inter', sans-serif; background-color: #f9fafb; }
.autocomplete-list {
  position: absolute;
  background: white;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  margin-top: 2px;
  z-index: 100;
  width: 100%;
  max-height: 200px;
  overflow-y: auto;
  box-shadow: 0 4px 10px rgba(0,0,0,0.05);
}
.autocomplete-item { padding: 8px; cursor: pointer; font-size: 0.875rem; }
.autocomplete-item:hover { background-color: #e0f2fe; }
</style>
</head>
<body>
<form method="POST">
{% csrf_token %}
<div class="invoice-card mx-auto max-w-5xl bg-white shadow-lg rounded-lg p-6 mt-8">

<!-- Header -->
<div class="flex justify-between items-start mb-6 border-b border-gray-300 pb-4">
  <div>
    <h1 class="text-3xl font-extrabold text-gray-800">SMARTSTOCK SUPERMARKET</h1>
    <p class="text-sm">123 Business St, Suite 456, Billing City, ST 12345</p>
    <p class="text-sm">üìß contact@smartstock.com | ‚òé 1800-456-789</p>
  </div>
  <div class="text-right">
    <p class="text-sm font-medium">Invoice No: <span class="font-bold">INV-{{ invoice_number }}</span></p>
    <p class="text-sm" id="invoice_date"></p>
  </div>
</div>

<!-- Customer -->
<div class="mb-4">
<h3 class="text-md font-semibold mb-1">Customer Name</h3>
<input type="text" name="customer_name"
       placeholder="Enter customer name"
       class="w-full border border-gray-300 rounded-md p-2 text-sm"
       required>
</div>

<!-- Item Selection (Autocomplete) -->
<div class="flex flex-col md:flex-row items-center gap-4 mb-6 bg-gray-50 p-4 rounded-md shadow-sm relative">
  <div class="w-full md:w-1/2 relative">
    <label class="block text-sm font-medium mb-1">Select Product</label>
    <input type="text" id="productSearch"
           placeholder="Type to search product..."
           class="w-full border border-gray-300 rounded-md p-2 text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none"
           autocomplete="off">
    <input type="hidden" id="selectedProductId">
    <div id="autocompleteList" class="autocomplete-list hidden">
      {% for p in products %}
      <div class="autocomplete-item"
           data-id="{{ p.id }}"
           data-name="{{ p.name }}"
           data-stock="{{ p.stock }}"
           data-price="{{ p.price }}">
        {{ p.name }} 
      </div>
      {% endfor %}
    </div>
  </div>
  <div>
    <label class="block text-sm font-medium mb-1">Quantity</label>
    <input type="number" id="quantityInput" class="border border-gray-300 rounded-md p-2 w-24 text-center" min="1" value="1">
  </div>
  <div class="w-full md:w-auto">
    <button type="button" id="addItemBtn" 
            class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 w-full mt-2 md:mt-5 transition duration-150 hover:scale-[1.02] disabled:bg-blue-400">
            ‚ûï Add Item
    </button>
  </div>
</div>

<!-- Product Table -->
<div class="overflow-x-auto border border-gray-200 rounded-lg mb-6">
  <table class="min-w-full text-sm text-gray-800" id="billTable">
    <thead class="bg-gray-100">
      <tr>
        <th class="text-left px-4 py-2 font-semibold">Item</th>
        <th class="text-center px-2 py-2 font-semibold">Price</th>
        <th class="text-center px-2 py-2 font-semibold">Qty</th>
        <th class="text-right px-4 py-2 font-semibold">Total</th>
        <th class="text-center px-2 py-2 font-semibold no-print">Action</th>
      </tr>
    </thead>
    <tbody id="billBody"></tbody>
  </table>
</div>

<!-- Totals -->
<div class="flex justify-end">
  <div class="w-full md:w-1/3">
    <div class="flex justify-between py-1 border-t border-dotted">
      <span>Subtotal</span><span id="subtotal">‚Çπ0.00</span>
    </div>
    <div class="flex justify-between py-1">
      <span>GST (8%)</span><span id="tax">‚Çπ0.00</span>
    </div>
    <div class="flex justify-between py-1 font-bold border-t border-dotted text-lg">
      <span>Total</span><span id="grand-total">‚Çπ0.00</span>
    </div>
  </div>
</div>

<!-- Footer -->
<div class="text-center mt-8 border-t border-gray-200 pt-4 text-xs text-gray-600">
  <p>Thank you for shopping with SmartStock Supermarket!</p>
  <p>Visit Again üòä</p>
</div>

<!-- Buttons -->
<div class="flex justify-between items-center mt-6 no-print">
  <a href="{% url 'staff_dashboard' %}" class="text-sm bg-gray-500 text-white px-4 py-2 rounded-md hover:bg-gray-600">
    ‚Üê Back to Dashboard
  </a>
  <div class="flex gap-2">
    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">
      ‚úÖ Proceed
    </button>
  </div>
</div>

<!-- Hidden Inputs Container -->
<div id="hiddenInputs"></div>

</div>
</form>

<script>
const productSearch = document.getElementById('productSearch');
const autocompleteList = document.getElementById('autocompleteList');
const selectedProductId = document.getElementById('selectedProductId');
const quantityInput = document.getElementById('quantityInput');
const addItemBtn = document.getElementById('addItemBtn');
const billBody = document.getElementById('billBody');
const subtotalEl = document.getElementById('subtotal');
const taxEl = document.getElementById('tax');
const grandEl = document.getElementById('grand-total');
const hiddenInputs = document.getElementById('hiddenInputs');
let itemCounter = 0;

// Autocomplete
productSearch.addEventListener('input', () => {
  const filter = productSearch.value.toLowerCase();
  const items = autocompleteList.querySelectorAll('.autocomplete-item');
  let visible = 0;
  items.forEach(item => {
    const name = item.dataset.name.toLowerCase();
    if (name.includes(filter) && filter.length > 0) {
      item.classList.remove('hidden');
      visible++;
    } else item.classList.add('hidden');
  });
  autocompleteList.classList.toggle('hidden', visible === 0);
});

autocompleteList.addEventListener('click', e => {
  const item = e.target.closest('.autocomplete-item');
  if(item){
    productSearch.value = item.dataset.name;
    selectedProductId.value = item.dataset.id;
    productSearch.dataset.price = item.dataset.price;
    productSearch.dataset.stock = item.dataset.stock;
    autocompleteList.classList.add('hidden');
    quantityInput.focus();
  }
});

document.addEventListener('click', e => {
  if(!e.target.closest('#productSearch') && !e.target.closest('#autocompleteList'))
    autocompleteList.classList.add('hidden');
});

// Add Item
function updateTotals(){
  let subtotal=0;
  billBody.querySelectorAll('tr').forEach(r=>{ subtotal+=parseFloat(r.querySelector('.item-total').dataset.value); });
  const tax=subtotal*0.08; const grand=subtotal+tax;
  subtotalEl.textContent=`‚Çπ${subtotal.toFixed(2)}`;
  taxEl.textContent=`‚Çπ${tax.toFixed(2)}`;
  grandEl.textContent=`‚Çπ${grand.toFixed(2)}`;
}

addItemBtn.addEventListener('click', ()=>{
  const id=selectedProductId.value;
  const name=productSearch.value;
  const price=parseFloat(productSearch.dataset.price||0);
  const stock=parseInt(productSearch.dataset.stock||0);
  const qty=parseInt(quantityInput.value);

  if(!id) return alert("Select a product");
  if(qty>stock) return alert(`Only ${stock} units available`);
  if(billBody.querySelector(`tr[data-id="${id}"]`)) return alert("Item already added");

  const total=price*qty;
  const tr=document.createElement('tr');
  tr.dataset.id=id;
  tr.innerHTML=`
    <td class="px-4 py-2">${name}</td>
    <td class="text-center px-2 py-2">‚Çπ${price.toFixed(2)}</td>
    <td class="text-center px-2 py-2">${qty}</td>
    <td class="text-right px-4 py-2 item-total" data-value="${total}">‚Çπ${total.toFixed(2)}</td>
    <td class="text-center no-print"><button class="text-red-500 hover:text-red-700 remove-item">‚úñ</button></td>
  `;
  billBody.appendChild(tr);

  // ‚úÖ Hidden inputs for Django view (quantity_index pattern)
  const pidInput=document.createElement('input');
  pidInput.type='hidden';
  pidInput.name='product_ids';
  pidInput.value=`${id}:${itemCounter}`;
  hiddenInputs.appendChild(pidInput);

  const qtyInput=document.createElement('input');
  qtyInput.type='hidden';
  qtyInput.name=`quantity_${itemCounter}`;
  qtyInput.value=qty;
  hiddenInputs.appendChild(qtyInput);

  tr.querySelector('.remove-item').addEventListener('click', ()=>{
    tr.remove(); pidInput.remove(); qtyInput.remove(); updateTotals();
  });

  itemCounter++;
  updateTotals();
  productSearch.value=''; selectedProductId.value=''; quantityInput.value=1;
});

const today=new Date();
document.getElementById('invoice_date').textContent=`Date: ${today.getDate().toString().padStart(2,'0')}-${(today.getMonth()+1).toString().padStart(2,'0')}-${today.getFullYear()}`;
</script>
</body>
</html>
